{% load file_size %} <!-- Load the custom filter here -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload PDF Documents</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Alpine.js for dynamic interactions -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center">

<div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl flex space-x-8">
    <!-- Display Django messages -->
    {% if messages %}
    <div class="fixed top-4 right-4 w-1/3">
        {% for message in messages %}
        <div class="p-4 mb-4 text-sm text-white rounded-md shadow-lg relative
            {% if message.tags == 'success' %} bg-green-500
            {% elif message.tags == 'error' %} bg-red-500
            {% elif message.tags == 'warning' %} bg-yellow-500
            {% else %} bg-gray-500
            {% endif %}">
            <span>{{ message }}</span>
            <!-- Close button -->
            <button class="absolute top-0 right-0 p-2 text-white font-bold hover:text-gray-300"
                    aria-label="Close" onclick="this.parentElement.style.display='none';">
                &times;
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}


    <!-- Left: Uploaded Files List -->
    <div class="w-1/2">
        <h2 class="text-lg font-semibold mb-2 text-left">Uploaded Files</h2> <!-- Smaller title, left-aligned -->
        <ul class="mt-2 space-y-2 max-h-80 overflow-y-auto"> <!-- Max height and scrollable -->
            {% for file in user_files %}
            <li class="flex items-start bg-gray-100 p-3 rounded-lg shadow-sm" data-file-id="{{ file.id }}">
                <!-- Icon -->
                <div class="flex-shrink-0">
                    <i class="fas fa-file-pdf text-red-500 text-2xl"></i> <!-- Smaller icon -->
                </div>
                <!-- File Information -->
                <div class="ml-3 flex-1">
                    <!-- File Name -->
                    <div class="text-sm font-medium text-gray-800">{{ file.name }}</div>
                    <!-- File Size and Upload Date (on the same row) -->
                    <div class="flex justify-between text-xs text-gray-500 mt-1"> <!-- Flex for inline layout -->
                        <p>{{ file.length|bytes_to_mb }}</p>
                        <p>{{ file.upload_date|date:"F j, Y" }}</p>
                    </div>
                </div>
                <!-- Action Buttons (View and Delete) -->
                <div class="flex flex-col space-y-2 ml-4">
                    <!-- View Button -->
                    <a href="{% url 'serve_protected_file' file.id %}" class="text-blue-500 hover:text-blue-700">
                        <i class="fa-solid fa-download"></i>
                    </a>
                    <!-- Delete Button -->
                    <button type="button" class="text-red-500 hover:text-red-700 delete-file-btn">
                        <i class="fas fa-trash-alt"></i> <!-- Delete icon -->
                    </button>
                </div>
            </li>
            {% empty %}
            <p class="text-gray-500 text-left">No files uploaded yet.</p> <!-- Left-aligned empty message -->
            {% endfor %}
        </ul>
    </div>

    <!-- Right: File Upload Form -->
    <div class="w-1/2" x-data="fileUploadHandler()">
        <h2 class="text-lg font-semibold mb-2 text-left">Upload Files</h2> <!-- Smaller title, left-aligned -->

        <div class="border-dashed border-2 border-gray-300 py-4 px-4 text-center rounded-lg">
            <div class="text-sm text-gray-600" x-show="!files.length">Drop files here</div>
            <div class="text-gray-400 my-1">Or</div>
            <label for="file-upload"
                   class="bg-white border border-gray-300 py-1 px-2 rounded-lg cursor-pointer hover:bg-gray-50 text-gray-700 font-medium text-sm">
                Browse
            </label>
            <input id="file-upload" name="files" type="file" multiple class="hidden" @change="handleFileUpload"/>
        </div>

        <!-- Selected Files -->
        <template x-if="files.length">
            <div class="mt-3 space-y-2">
                <template x-for="(file, index) in files" :key="index">
                    <div class="flex items-center justify-between bg-gray-100 rounded-md p-2">
                        <span class="text-sm text-gray-800" x-text="file.name"></span>
                        <button type="button" @click="removeFile(index)"
                                class="text-red-500 hover:text-red-700 text-xs">âœ•
                        </button> <!-- Smaller remove button -->
                    </div>
                </template>
            </div>
        </template>

        <!-- Progress Bar -->
        <template x-if="progress !== 0">
            <div class="mt-4">
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div class="text-sm font-semibold inline-block text-blue-500">
                            Uploading...
                        </div>
                    </div>
                    <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200">
                        <div class="bg-blue-500 transition-all duration-300 ease-in-out"
                             :style="`width: ${progress}%`"></div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Submit Button -->
        <button type="button" @click="submitFiles"
                class="w-full bg-blue-600 text-white py-2 px-3 mt-4 rounded-md hover:bg-blue-700 transition">
            Upload files
        </button>

        <!-- Toast Notifications -->
        <div x-show="toastMessage" class="fixed bottom-4 right-4 bg-green-500 text-white py-2 px-4 rounded-md shadow-lg"
             x-text="toastMessage"></div>
    </div>
</div>

<!-- Alpine.js File Upload Handler -->
<script>
    function fileUploadHandler() {
        return {
            files: [],
            progress: 0,
            toastMessage: '',

            handleFileUpload(event) {
                this.files = Array.from(event.target.files);
            },

            removeFile(index) {
                this.files.splice(index, 1);
            },

            async submitFiles() {
                if (this.files.length === 0) return;

                this.progress = 0;
                this.toastMessage = '';  // Reset the toast message

                const formData = new FormData();
                for (let i = 0; i < this.files.length; i++) {
                    formData.append('files', this.files[i]);
                }
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}'); // Add CSRF token for Django

                // Use Fetch API to send the files via AJAX
                try {
                    const response = await this.uploadWithProgress("{% url 'upload_file' %}", formData);
                    if (response.status == 200) {
                        location.reload();
                    } else {
                        this.showToast("Error uploading file.", true);
                    }
                } catch (error) {
                    this.showToast("Error uploading file.", true);
                }
            },

            async uploadWithProgress(url, formData) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", url);

                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            this.progress = Math.round((event.loaded / event.total) * 100);
                        }
                    };

                    xhr.onload = () => resolve(xhr);
                    xhr.onerror = () => reject(xhr);

                    xhr.send(formData);
                });
            },

            showToast(message, isError = false) {
                this.toastMessage = message;
                setTimeout(() => {
                    this.toastMessage = '';
                }, 2000);
            }
        }
    }

    // Delete file handler
    document.querySelectorAll('.delete-file-btn').forEach(button => {
        button.addEventListener('click', function () {
            const fileItem = this.closest('li');
            const fileId = fileItem.getAttribute('data-file-id');

            fetch(`/delete-file/${fileId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting file:', error);
            });
        });
    });
</script>

</body>
</html>
