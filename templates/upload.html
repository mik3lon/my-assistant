<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload PDF Documents</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Alpine.js for dynamic interactions -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center">

<div x-show="loading" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="flex flex-col items-center space-y-2">
        <!-- Spinner -->
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500"></div>
        <!-- Loading Text -->
        <p class="text-white text-lg">Loading files...</p>
    </div>
</div>

<div class="w-full max-w-6xl bg-white p-6 rounded-lg shadow-lg space-y-8">
    <div class="w-full flex space-x-8">
        {% include 'partials/messages.html' with messages=messages %}
        {% include 'partials/file_list.html' with user_files=user_files %}
        {% include 'partials/upload_form.html' with user_files=user_files %}
    </div>
    <div class="w-full">
        {% include 'partials/chat.html' with message_text="Hello from the partial view!" %}
    </div>
</div>





<!-- Alpine.js File Upload Handler -->
<script>
    function fileUploadHandler() {
        return {
            files: [],
            progress: 0,
            toastMessage: '',
            loading: false,  // Default loading is false

            handleFileUpload(event) {
                this.files = Array.from(event.target.files);
            },

            removeFile(index) {
                this.files.splice(index, 1);
            },

            async processDocuments() {
                this.loading = true;  // Show the loading overlay

                try {
                    const response = await fetch("{% url 'process_docs' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.showToast(data.message);
                    } else {
                        const errorData = await response.json();
                        this.showToast(errorData.error, true);
                    }
                } catch (error) {
                    this.showToast("Error processing documents.", true);
                } finally {
                    this.loading = false;  // Hide the loading overlay
                }
            },

            async submitFiles() {
                if (this.files.length === 0) return;

                this.progress = 0;
                this.toastMessage = '';  // Reset the toast message

                const formData = new FormData();
                for (let i = 0; i < this.files.length; i++) {
                    formData.append('files', this.files[i]);
                }
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}'); // Add CSRF token for Django

                // Use Fetch API to send the files via AJAX
                try {
                    const response = await this.uploadWithProgress("{% url 'upload_file' %}", formData);
                    if (response.status == 200) {
                        location.reload();
                    } else {
                        this.showToast("Error uploading file.", true);
                    }
                } catch (error) {
                    this.showToast("Error uploading file.", true);
                }
            },

            async uploadWithProgress(url, formData) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", url);

                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            this.progress = Math.round((event.loaded / event.total) * 100);
                        }
                    };

                    xhr.onload = () => resolve(xhr);
                    xhr.onerror = () => reject(xhr);

                    xhr.send(formData);
                });
            },

            showToast(message, isError = false) {
                this.toastMessage = message;
                setTimeout(() => {
                    this.toastMessage = '';
                }, 2000);
            }
        }
    }

    // Delete file handler
    document.querySelectorAll('.delete-file-btn').forEach(button => {
        button.addEventListener('click', function () {
            const fileItem = this.closest('li');
            const fileId = fileItem.getAttribute('data-file-id');

            fetch(`/delete-file/${fileId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error deleting file:', error);
                });
        });
    });
</script>

</body>
</html>
